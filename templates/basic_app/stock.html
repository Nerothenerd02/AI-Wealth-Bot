{% extends 'basic_app/base.html' %}
{% load static %}
{% block content %}
  <!-- Chart libraries -->
  <script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-stock.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-data-adapter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Stock Overview -->
  <div class="card card-body p-10px">
    <div class="row">
      <div class="col text-center">
        <h1>{{ info.shortName }}</h1>
        {% if recommendation %}
          <p class="text-success">We recommend buying this stock</p>
        {% else %}
          <p class="text-danger">We do not recommend buying this stock</p>
        {% endif %}
      </div>
      <div class="col-4 text-end">
        <a href="{{ info.symbol }}/add" class="btn btn-primary">Add to Portfolio</a>
        <a href="{% url 'basic_app:prediction' info.symbol %}" class="btn btn-success">See Price Prediction</a>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col">
        <p>{{ info.longBusinessSummary }}</p>
      </div>
    </div>
  </div>

  <br>

  <div class="row">
    <!-- Technical Analysis -->
    <div class="col">
      <div class="card card-body">
        <h2 class="text-center">Technical Analysis</h2>
        <div class="row align-items-center">
          <label class="col-auto">Add an indicator:</label>
          <div class="col-6">
            <select id="indicatorSelect" class="form-select">
              <option value="NONE" selected>None</option>
              <option value="BB">BB</option>
              <option value="Pivots">Pivots</option>
              <option value="EMA">EMA</option>
              <option value="SMA">SMA</option>
              <option value="MACD">MACD</option>
              <option value="RSI">RSI</option>
              <option value="OBV">OBV</option>
            </select>
          </div>
          <div class="col-auto">
            <button id="resetButton" class="btn btn-primary btn-sm">Reset</button>
          </div>
        </div>
        <div id="chart-box" class="mt-3" style="height:500px; width:650px;"></div>
      </div>
    </div>

    <!-- Financial & Sentiment Analysis -->
    <div class="col">
      <!-- Piotroski Score -->
      <div class="card card-body mb-3">
        <h2 class="text-center">Financial Analysis</h2>
        <h3>Piotroski Score</h3>
        <p>The Piotroski Score (0â€“9) reflects nine criteria used to determine the strength of a firm's financial position.</p>
        <a href="https://www.investopedia.com/terms/p/piotroski-score.asp" target="_blank">More about the Piotroski Score</a>
        <h5 class="mt-2">Score: {{ piotroski_score }}</h5>
        <div class="progress">
          <div id="piotroski-bar" class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
      </div>

      <!-- News Sentiment -->
      <div class="card card-body">
        <h2 class="text-center">News Sentiment</h2>
        <canvas id="sentimentChart" width="400" height="130"></canvas>
      </div>
    </div>
  </div>

  {# Inline JSON data safely via json_script #}
  {{ data|json_script:"historical-data" }}
  {{ item|json_script:"metadata" }}
  {{ sentiment_data|json_script:"sentiment-data" }}
  <script id="piotroski-score" type="application/json">{{ piotroski_score }}</script>

  <script>
    // Parse JSON blobs from <script type="application/json"> tags
    const historicalData = JSON.parse(document.getElementById('historical-data').textContent);
    const metadata       = JSON.parse(document.getElementById('metadata').textContent);
    const sentimentStats = JSON.parse(document.getElementById('sentiment-data').textContent);
    const piotroskiScore = JSON.parse(document.getElementById('piotroski-score').textContent);
  
    // 1) Animate Piotroski bar
    (function animateBar() {
      const pct = Math.floor((piotroskiScore / 9) * 100);
      const bar = document.getElementById('piotroski-bar');
      let current = 0;
      (function step() {
        if (current <= pct) {
          bar.style.width = current + '%';
          bar.classList.toggle('bg-danger', current < 33);
          bar.classList.toggle('bg-warning', current >= 33 && current < 66);
          bar.classList.toggle('bg-success', current >= 66);
          current++;
          setTimeout(step, 20);
        }
      })();
    })();
  
    // 2) Initialize and draw the stock chart
    let stockChart;
    function drawStock() {
      stockChart = anychart.stock();
      const table = anychart.data.table('Date');
      table.addData(historicalData);
  
      const mapping = table.mapAs({ open: 'Open', high: 'High', low: 'Low', close: 'Close' });
  
      const plot0 = stockChart.plot(0);
      plot0.candlestick(mapping).name(metadata.name + ' Candlestick');
  
      stockChart.title(metadata.name + ' Candlestick Chart');
      stockChart.container('chart-box');
      stockChart.draw();
  
      // Auto-zoom to last 6 months
      const dataLength = historicalData.length;
      if (dataLength > 120) {
        stockChart.selectRange(
          historicalData[dataLength - 120]['Date'], 
          historicalData[dataLength - 1]['Date']
        );
      }
    }
  
    drawStock();
  
    // 3) Reset & Indicator logic
    document.getElementById('resetButton').addEventListener('click', () => {
      stockChart.dispose();
      drawStock();
      document.getElementById('indicatorSelect').value = 'NONE';
    });
  
    document.getElementById('indicatorSelect').addEventListener('change', function () {
      const plot = stockChart.plot(0);
      const mapping = plot.getSeries().mapping;
  
      // Clear all secondary plots
      for (let i = 1; i < stockChart.plotsCount(); i++) {
        stockChart.plot(i).removeAllSeries();
      }
  
      switch (this.value) {
        case 'RSI':
          stockChart.plot(1).rsi(mapping, 14).series();
          stockChart.plot(1).title('Relative Strength Index (RSI)');
          break;
        case 'MACD':
          stockChart.plot(1).macd(mapping, 12, 26, 9);
          stockChart.plot(1).title('MACD Indicator');
          break;
        case 'OBV':
          stockChart.plot(1).obv(mapping);
          stockChart.plot(1).title('On Balance Volume (OBV)');
          break;
        case 'SMA':
          plot.sma(mapping, 20).series();
          break;
        case 'EMA':
          plot.ema(mapping, 20).series();
          break;
        case 'BB':
          const bb = plot.bbands(mapping);
          bb.upperSeries().stroke('#bf360c');
          bb.middleSeries().stroke('#ff6600');
          bb.lowerSeries().stroke('#bf360c');
          bb.rangeSeries().fill('#ffd54f 0.2');
          break;
        case 'Pivots':
          plot.priceIndicator();
          break;
        default:
          break;
      }
    });
  
    // 4) Chart.js for News Sentiment
    new Chart(document.getElementById('sentimentChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Positive', 'Negative', 'Neutral'],
        datasets: [{
          label: 'News Sentiment',
          data: [
            sentimentStats.positive,
            sentimentStats.negative,
            sentimentStats.neutral
          ],
          backgroundColor: ['#4CAF50', '#F44336', '#9E9E9E']
        }]
      },
      options: {
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true }
        }
      }
    });
  </script>
  
{% endblock %}
